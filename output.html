<html>
    <head>
        <meta Content-Type:text/html; charset="UTF-8">
        <title>SnuInfoVis Term Project - GPS</title>
    </head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>

        let SVG_AREA_WIDTH = 500;
        let SVG_AREA_HEIGHT = 500;
        let AREA_MARGINS = {TOP:20, RIGHT:20, BOTTOM:30, LEFT:40};
        let AREA_WIDTH = SVG_AREA_WIDTH - AREA_MARGINS.LEFT - AREA_MARGINS.RIGHT;
        let AREA_HEIGHT = SVG_AREA_HEIGHT - AREA_MARGINS.TOP - AREA_MARGINS.BOTTOM;
        let GENRE_CATEGORY = ['k-pop', 'hiphop', 'classic', 'rock', 'r&b', 'jazz', 'country', 'pop']

        let mData; // load json
        let mMinYear = 1970; // fixed
        let mMaxYear = 0;

        let mSelectedYear = 2010;
        let mSelectedsimpleGenre = GENRE_CATEGORY[0];
        let mSelectedIndex = "danceability";
        let mSelectedPopularity = 72;

        d3.json("data.json").then(function(data) {
            mData = data;
            init();
        });

        function init() {
            console.log("mData size : " + mData.length);
            d3.select("h1").text("Hello!");

            let bts = getSongById("6Z7m5DLNPOaPg9T6nXK0rQ");
            console.log("BTS - DNA");
            console.log("- title : " + bts.title);
            console.log("- artist : " + bts.artist);
            console.log("- genre : " + bts.genre);
            console.log("- date : " + bts.date);
            console.log("- id : " + bts.id);
            console.log("- key : " + bts.key);
            console.log("- duration_ms : " + bts.duration_ms);
            console.log("- mode : " + bts.mode);
            console.log("- popularity : " + bts.popularity);
            console.log("- tempo : " + bts.tempo);
            console.log("- loudness : " + bts.loudness);
            console.log("- explicit : " + bts.explicit);
            console.log("- acousticness : " + bts.acousticness);
            console.log("- danceability : " + bts.danceability);
            console.log("- energy : " + bts.energy);
            console.log("- instrumentalness : " + bts.instrumentalness);
            console.log("- liveness : " + bts.liveness);
            console.log("- speechiness : " + bts.speechiness);
            console.log("- valence : " + bts.valence);
            /*
            let twoNE1 = getSongById("26EM9sZnQkLLQxixGd88KE");
            console.log("2NE1 - I Am The Best");
            console.log("- title : " + twoNE1.title);
            console.log("- artist : " + twoNE1.artist);
            console.log("- genre : " + twoNE1.genre);
            console.log("- date : " + twoNE1.date);
            console.log("- id : " + twoNE1.id);
            console.log("- key : " + twoNE1.key);
            console.log("- duration_ms : " + twoNE1.duration_ms);
            console.log("- mode : " + twoNE1.mode);
            console.log("- popularity : " + twoNE1.popularity);
            console.log("- tempo : " + twoNE1.tempo);
            console.log("- loudness : " + twoNE1.loudness);
            console.log("- explicit : " + twoNE1.explicit);
            console.log("- acousticness : " + twoNE1.acousticness);
            console.log("- danceability : " + twoNE1.danceability);
            console.log("- energy : " + twoNE1.energy);
            console.log("- instrumentalness : " + twoNE1.instrumentalness);
            console.log("- liveness : " + twoNE1.liveness);
            console.log("- speechiness : " + twoNE1.speechiness);
            console.log("- valence : " + twoNE1.valence);

            let girlsGeneration = getSongById("2BQIMF7CyLe2xAKzh74A4C");
            console.log("Girls Generation - Gee");
            console.log("- title : " + girlsGeneration.title);
            console.log("- artist : " + girlsGeneration.artist);
            console.log("- genre : " + girlsGeneration.genre);
            console.log("- date : " + girlsGeneration.date);
            console.log("- id : " + girlsGeneration.id);
            console.log("- key : " + girlsGeneration.key);
            console.log("- duration_ms : " + girlsGeneration.duration_ms);
            console.log("- mode : " + girlsGeneration.mode);
            console.log("- popularity : " + girlsGeneration.popularity);
            console.log("- tempo : " + girlsGeneration.tempo);
            console.log("- loudness : " + girlsGeneration.loudness);
            console.log("- explicit : " + girlsGeneration.explicit);
            console.log("- acousticness : " + girlsGeneration.acousticness);
            console.log("- danceability : " + girlsGeneration.danceability);
            console.log("- energy : " + girlsGeneration.energy);
            console.log("- instrumentalness : " + girlsGeneration.instrumentalness);
            console.log("- liveness : " + girlsGeneration.liveness);
            console.log("- speechiness : " + girlsGeneration.speechiness);
            console.log("- valence : " + girlsGeneration.valence);
            */

            // update year range from data.
            for (let i = 0 ; i < mData.length ; i++) {
                let year = mData[i].date.substring(0, 4);
                // mMinYear = Math.min(mMinYear, parseInt(year));
                mMaxYear = Math.max(mMaxYear, parseInt(year));
            }
            console.log("min year : " + mMinYear + ", max year : " + mMaxYear);

            drawAreaChart();
            drawVasePlot();
            drawLineChart();
            drawTable();
        }

        // -------------------- UTIL apis --------------------
        function translate(x, y) {
            return 'translate(' + x + ', ' + y + ')';
        }

        function getSongById(id) {
            for (let i = 0 ; i < mData.length ; i++) {
                if (id == mData[i].id) {
                    return mData[i];
                }
            }
        }

        function getSongsByYear(year) {
            let ret = [];
            for (let i = 0 ; i < mData.length ; i++) {
                if (mData[i].date.substring(0, 4) == year) {
                    ret.push(mData[i]);
                }
            }
            return ret;
        }

        function getColorByGenre(simpleGenre) {
            for (let i = 0 ; i < GENRE_CATEGORY.length ; i++) {
                if (simpleGenre == GENRE_CATEGORY[i]) {
                    return d3.schemeCategory10[i];
                }
            }
        }

        // -------------------- DRAWING APIs --------------------
        function drawAreaChart() {
            let areaChartSvg = d3.select('#area');
            let dataByYear = [];

            // axis
            let areaX = d3.scaleLinear().domain([mMinYear, mMaxYear + 1 /* +1 for 2020 data */ ])
                    .range([0, AREA_WIDTH]);
            let areaXAxis = d3.axisBottom(areaX).tickFormat(d3.format("d"));
            areaChartSvg.append("g").attr('transform', translate(AREA_MARGINS.LEFT,
                    AREA_HEIGHT + AREA_MARGINS.TOP)).call(areaXAxis);

            let areaY = d3.scaleLinear().domain([100, 0]).range([0, AREA_HEIGHT]);
            let areaYAxis = d3.axisLeft(areaY);
            areaChartSvg.append("g").attr('transform', translate(AREA_MARGINS.LEFT, AREA_MARGINS.TOP))
                    .call(areaYAxis);

            let xUnit = AREA_WIDTH / (mMaxYear - mMinYear);
            let yUnit = AREA_HEIGHT / 100;

            // prepare prev values
            let prevSongs = getSongsByYear(mMinYear - 1);
            let prevData = {};

            for (let i = 0 ; i < GENRE_CATEGORY.length ; i++) {
                prevData[ GENRE_CATEGORY[ i ] ] = 0;
            }

            for (let i = 0 ; i < prevSongs.length ; i++) {
                for (let j = 0 ; j < GENRE_CATEGORY.length ; j++) {
                    if (prevSongs[i].genre == GENRE_CATEGORY[j]) {
                        prevData[ GENRE_CATEGORY[j] ]++;
                    }
                }
            }

            /*
            d3.select('#area').append('path').attr('class', 'k-pop')
                        .attr('fill', getColorBySimpleGenre('k-pop'))
                        .attr('stroke', getColorBySimpleGenre('k-pop'))
                        .attr('d', 'M ' + 100 + ' ' + 100 + ' L ' + 200 + ' ' + 200);
            */
            /*
            console.log("prevSongs.length : " + prevSongs.length);
            console.log("prevData : ");
            console.log(prevData);
            */

            // year loop for lines
            for (let i = mMinYear ; i <= mMaxYear ; i++) {
                let curSongs = getSongsByYear(i);
                let curData  = {};
                for (let j = 0 ; j < GENRE_CATEGORY.length ; j++) {
                    curData[ GENRE_CATEGORY[j] ] = 0;
                }

                // console.log(curData);
                for (let j = 0 ; j < curSongs.length ; j++) {
                    for (let k = 0 ; k < GENRE_CATEGORY.length ; k++) {
                        if (curSongs[j].genre == GENRE_CATEGORY[ k ]) {
                            curData[ GENRE_CATEGORY[ k ] ]++;
                        }
                    }
                }

                console.log("year : " + i + ", songs : " + curSongs.length);
                console.log(curData);

                /*
                // lines
                let accumulatedY = 0;
                let prevX = AREA_MARGINS.LEFT + ((i - mMinYear) * xUnit);
                let curX = prevX + xUnit;
                for (let j = 0 ; j < GENRE_CATEGORY.length ; j++) {
                    let curSimpleGenre = GENRE_CATEGORY[ j ];
                    let prevY = (prevData[ curSimpleGenre ] / prevSongs.length) * 100; // percentage
                    console.log("prevData[ curSimpleGenre ] : " + prevData[ curSimpleGenre ]);

                    let curY = (curData[ curSimpleGenre ] / curSongs.length) * 100; // percentage
                    console.log("curYear : " + i + " curGenre : " + curSimpleGenre + " prevX : "
                            + prevX + " prevY : " + prevY + " curX : " + curX + " curY : " + curY);
                    d3.select('#area').append('path').attr('class', curSimpleGenre)
                            .attr('stroke', getColorBySimpleGenre(curSimpleGenre))
                            .attr('fill', getColorBySimpleGenre(curSimpleGenre))
                            .attr('d', 'M ' + prevX + ' ' + AREA_HEIGHT - (prevY * yUnit)
                                    + ' L ' + curX + ' ' + AREA_HEIGHT - (curY * yUnit));
                    accumulatedY += curY;
                }
                */
            }
        }

        function drawVasePlot() {
            // TODO 조남우 draws a chart considering mSelectedYear, mSelectedGenre.
            // TODO update mSelectedIndex as user selection.
            // TODO call drawLineChart().
        }

        function drawLineChart() {
            // TODO 석상윤 draws a chart considering mSelectedYear, mSelectedGenre, mSelectedIndex
            // TODO update mSelectedPopularity as user selection.
            // TODO call drawTable().
        }

        function drawTable() {
            // TODO 남재호 draws a song table filtered by mSelectedYear, mSelectedGenre,
            //      mSelectedIndex, mSelectedPopularity
            // TODO show more info for a song when mouse on
            // TODO open selected song's spotify url.
        }

    </script>
    <body>
        <h1>Loading...</h1>
        <svg id="area" width=500 height=500 style="border:black 1px solid"/>
    </body>
</html>
